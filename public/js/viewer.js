var v=`${location.protocol==="https:"?"wss":"ws"}://${location.host}/ws`;function o(e){let n=document.querySelector(e);if(!n)throw new Error(`Viewer UI failed to initialise (${e})`);return n}var c=o("#stream"),p=o("#status"),b=o("#live-indicator"),w=o("#interaction-overlay"),y=o("#resume"),S=o("#waiting-indicator"),d=o("#viewer-count"),r=null,s=null,t=null;function i(e){p.textContent=e}function g(e){b.toggleAttribute("hidden",!e)}function a(e){S.classList.toggle("hidden",!e)}function m(){w.classList.remove("hidden")}function l(){w.classList.add("hidden")}function L(e){if(e<=0){d.textContent="No one watching yet",d.toggleAttribute("hidden",!0);return}d.textContent=e===1?"1 person watching":`${e} people watching`,d.toggleAttribute("hidden",!1)}async function f(e={}){if(!c.srcObject)return!1;try{return await c.play(),l(),!0}catch(n){if(!e.userGesture)m();return console.warn("Autoplay prevented, waiting for user interaction",n),!1}}function h(){r=new WebSocket(v),r.addEventListener("open",()=>{r?.send(JSON.stringify({type:"register",role:"viewer"})),i("Connected. Waiting for broadcaster..."),a(!0)}),r.addEventListener("message",async(e)=>{let n=JSON.parse(e.data);await C(n)}),r.addEventListener("close",()=>{i("Connection closed."),u()}),r.addEventListener("error",()=>{i("Signalling error")})}async function C(e){switch(e.type){case"registered":if(s=e.viewerId,e.hasBroadcaster)i("Broadcaster available. Preparing stream..."),a(!1);else i("Waiting for broadcaster to start streaming..."),a(!0);break;case"offer":if(!s||e.viewerId!==s)return;a(!1),i("Connecting to live stream..."),await E(),await t.setRemoteDescription(e.sdp);let n=await t.createAnswer();await t.setLocalDescription(n),r?.send(JSON.stringify({type:"answer",viewerId:s,sdp:n})),i("Receiving stream..."),f();break;case"candidate":if(e.origin==="broadcaster"&&t&&e.candidate)await t.addIceCandidate(e.candidate);break;case"broadcaster-ended":i("Broadcast ended. Waiting for it to restart..."),u(),a(!0),l();break;case"viewer-count":L(e.count);break;case"error":i(`Error: ${e.message}`);break}}async function E(){if(t)return;t=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}]}),t.ontrack=(e)=>{let[n]=e.streams;if(n)c.srcObject=n,c.muted=!1,g(!0),a(!1),f()},t.onicecandidate=(e)=>{if(!s||!e.candidate||!r||r.readyState!==WebSocket.OPEN)return;r.send(JSON.stringify({type:"candidate",viewerId:s,candidate:e.candidate,origin:"viewer"}))},t.onconnectionstatechange=()=>{if(!t)return;if(t.connectionState==="disconnected"||t.connectionState==="failed"||t.connectionState==="closed")u(),i("Connection to broadcaster lost."),a(!0)}}function u(){t?.close(),t=null,c.srcObject=null,g(!1),l()}window.addEventListener("beforeunload",()=>{u(),r?.close()});y.addEventListener("click",async()=>{l(),await f({userGesture:!0})});h();

//# debugId=B0745CAF70EDE19264756E2164756E21
//# sourceMappingURL=viewer.js.map
