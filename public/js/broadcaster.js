var v=`${location.protocol==="https:"?"wss":"ws"}://${location.host}/ws`,p=document.querySelector("#start"),u=document.querySelector("#stop"),w=document.querySelector("#status"),d=document.querySelector("#preview");if(!p||!u||!w||!d)throw new Error("Unable to initialise broadcaster UI");var n=null,a=null,r=new Map,s=new Set;function i(e){w.textContent=e}function l({canStart:e,canStop:t}){p.disabled=!e,u.disabled=!t}function y(){n=new WebSocket(v),n.addEventListener("open",()=>{n?.send(JSON.stringify({type:"register",role:"broadcaster"})),i("Connected to signalling server. Ready to share."),l({canStart:!0,canStop:!1})}),n.addEventListener("message",(e)=>{let t=JSON.parse(e.data);m(t)}),n.addEventListener("close",()=>{i("Signalling connection closed."),l({canStart:!1,canStop:!1}),h()}),n.addEventListener("error",()=>{i("Signalling connection error.")})}async function b(){if(!n||n.readyState!==WebSocket.OPEN){i("Not connected to signalling server yet.");return}try{a=await navigator.mediaDevices.getDisplayMedia({video:{displaySurface:"browser",frameRate:{ideal:60,max:60},width:{ideal:3840,max:3840},height:{ideal:2160,max:2160},aspectRatio:{ideal:1.7777777777777777},resizeMode:"none"},audio:!0});let[e]=a.getVideoTracks();if(e)e.contentHint="motion";if(d.srcObject=a,d.muted=!0,await d.play(),i("Sharing in progress. Waiting for viewers..."),l({canStart:!1,canStop:!0}),s.size>0)s.forEach((t)=>{S(t)})}catch(e){console.error("Failed to acquire display media",e),i("Screen capture was blocked or failed.")}}function g({notifyServer:e}){if(r.forEach(({connection:t})=>t.close()),r.clear(),a)a.getTracks().forEach((t)=>t.stop()),a=null;if(d.srcObject=null,e&&n&&n.readyState===WebSocket.OPEN)n.send(JSON.stringify({type:"stop"}));s.clear(),l({canStart:!0,canStop:!1}),i("Sharing stopped.")}function h(){r.forEach(({connection:e})=>e.close()),r.clear()}function k(e){if(!a)throw new Error("Media stream is not initialised");let t=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}]});return a.getTracks().forEach((c)=>{let f=t.addTrack(c,a);if(c.kind==="video"){let o=f.getParameters();if(!o.encodings||o.encodings.length===0)o.encodings=[{}];o.encodings[0]={...o.encodings[0],maxBitrate:18000000,maxFramerate:60,scaleResolutionDownBy:1},f.setParameters(o)}else if(c.kind==="audio"){let o=f.getParameters();if(!o.encodings||o.encodings.length===0)o.encodings=[{}];o.encodings[0]={...o.encodings[0],maxBitrate:192000},f.setParameters(o)}}),t.onicecandidate=(c)=>{if(c.candidate&&n&&n.readyState===WebSocket.OPEN)n.send(JSON.stringify({type:"candidate",viewerId:e,candidate:c.candidate,origin:"broadcaster"}))},t.onconnectionstatechange=()=>{if(t.connectionState==="disconnected"||t.connectionState==="failed"||t.connectionState==="closed")r.delete(e)},r.set(e,{connection:t}),t}async function S(e){if(!a){i("Viewer connected but sharing not started yet."),s.add(e);return}s.delete(e);let t=k(e),c=await t.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0});await t.setLocalDescription(c),n?.send(JSON.stringify({type:"offer",viewerId:e,sdp:c})),i(`Sharing to ${r.size} viewer(s).`)}async function m(e){switch(e.type){case"registered":l({canStart:!0,canStop:!1});break;case"viewer-joined":await S(e.viewerId);break;case"viewer-left":r.get(e.viewerId)?.connection.close(),r.delete(e.viewerId),s.delete(e.viewerId),i(`Viewer left. ${r.size} remaining.`);break;case"viewer-missing":r.get(e.viewerId)?.connection.close(),r.delete(e.viewerId),s.delete(e.viewerId),i("Viewer disconnected before the offer completed.");break;case"answer":{let t=r.get(e.viewerId)?.connection;if(t)await t.setRemoteDescription(e.sdp);break}case"candidate":{let t=r.get(e.viewerId)?.connection;if(t&&e.candidate)await t.addIceCandidate(e.candidate);break}case"viewer-count":{if(a){let t=e.count===1?"1 viewer":`${e.count} viewers`;i(`Sharing to ${t}.`)}break}case"stopped":g({notifyServer:!1});break;case"error":i(`Error: ${e.message}`);break;case"broadcaster-ended":i("Broadcast ended.");break}}p.addEventListener("click",()=>{b()});u.addEventListener("click",()=>{g({notifyServer:!0})});window.addEventListener("beforeunload",()=>{g({notifyServer:!0}),n?.close()});y();

//# debugId=A0A8BC3A4D219CC864756E2164756E21
//# sourceMappingURL=broadcaster.js.map
