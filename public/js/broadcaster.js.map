{
  "version": 3,
  "sources": ["../../src/client/broadcaster.ts"],
  "sourcesContent": [
    "export {};\n\nconst SIGNAL_URL = `${location.protocol === \"https:\" ? \"wss\" : \"ws\"}://${location.host}/ws`;\n\ntype ServerMessage =\n  | { type: \"registered\"; role: \"broadcaster\" }\n  | { type: \"viewer-joined\"; viewerId: string }\n  | { type: \"answer\"; viewerId: string; sdp: RTCSessionDescriptionInit }\n  | {\n      type: \"candidate\";\n      viewerId: string;\n      candidate: RTCIceCandidateInit;\n      origin: \"viewer\" | \"broadcaster\";\n    }\n  | { type: \"viewer-left\"; viewerId: string }\n  | { type: \"viewer-missing\"; viewerId: string }\n  | { type: \"viewer-count\"; count: number }\n  | { type: \"error\"; message: string }\n  | { type: \"stopped\" }\n  | { type: \"broadcaster-ended\" };\n\ntype PeerEntry = {\n  connection: RTCPeerConnection;\n};\n\nconst startButton = document.querySelector<HTMLButtonElement>(\"#start\");\nconst stopButton = document.querySelector<HTMLButtonElement>(\"#stop\");\nconst statusLabel = document.querySelector<HTMLParagraphElement>(\"#status\");\nconst preview = document.querySelector<HTMLVideoElement>(\"#preview\");\n\nif (!startButton || !stopButton || !statusLabel || !preview) {\n  throw new Error(\"Unable to initialise broadcaster UI\");\n}\n\nlet socket: WebSocket | null = null;\nlet mediaStream: MediaStream | null = null;\nconst peers = new Map<string, PeerEntry>();\nconst pendingViewers = new Set<string>();\n\nfunction setStatus(message: string) {\n  statusLabel.textContent = message;\n}\n\nfunction enableButtons({ canStart, canStop }: { canStart: boolean; canStop: boolean }) {\n  startButton.disabled = !canStart;\n  stopButton.disabled = !canStop;\n}\n\nfunction connectSocket() {\n  socket = new WebSocket(SIGNAL_URL);\n\n  socket.addEventListener(\"open\", () => {\n    socket?.send(JSON.stringify({ type: \"register\", role: \"broadcaster\" }));\n    setStatus(\"Connected to signalling server. Ready to share.\");\n    enableButtons({ canStart: true, canStop: false });\n  });\n\n  socket.addEventListener(\"message\", (event) => {\n    const data = JSON.parse(event.data) as ServerMessage;\n    handleServerMessage(data);\n  });\n\n  socket.addEventListener(\"close\", () => {\n    setStatus(\"Signalling connection closed.\");\n    enableButtons({ canStart: false, canStop: false });\n    cleanupPeers();\n  });\n\n  socket.addEventListener(\"error\", () => {\n    setStatus(\"Signalling connection error.\");\n  });\n}\n\nasync function startBroadcast() {\n  if (!socket || socket.readyState !== WebSocket.OPEN) {\n    setStatus(\"Not connected to signalling server yet.\");\n    return;\n  }\n\n  try {\n    mediaStream = await navigator.mediaDevices.getDisplayMedia({\n      video: {\n        displaySurface: \"browser\",\n        frameRate: { ideal: 60, max: 60 },\n        width: { ideal: 3840, max: 3840 },\n        height: { ideal: 2160, max: 2160 },\n        aspectRatio: { ideal: 16 / 9 },\n        resizeMode: \"none\",\n      },\n      audio: true,\n    });\n\n    const [videoTrack] = mediaStream.getVideoTracks();\n    if (videoTrack) {\n      videoTrack.contentHint = \"motion\";\n    }\n\n    preview.srcObject = mediaStream;\n    preview.muted = true;\n    await preview.play();\n\n    setStatus(\"Sharing in progress. Waiting for viewers...\");\n    enableButtons({ canStart: false, canStop: true });\n\n    if (pendingViewers.size > 0) {\n      pendingViewers.forEach((viewerId) => {\n        void handleViewerRequest(viewerId);\n      });\n    }\n  } catch (error) {\n    console.error(\"Failed to acquire display media\", error);\n    setStatus(\"Screen capture was blocked or failed.\");\n  }\n}\n\nfunction stopBroadcast({ notifyServer }: { notifyServer: boolean }) {\n  peers.forEach(({ connection }) => connection.close());\n  peers.clear();\n\n  if (mediaStream) {\n    mediaStream.getTracks().forEach((track) => track.stop());\n    mediaStream = null;\n  }\n\n  preview.srcObject = null;\n\n  if (notifyServer && socket && socket.readyState === WebSocket.OPEN) {\n    socket.send(JSON.stringify({ type: \"stop\" }));\n  }\n\n  pendingViewers.clear();\n  enableButtons({ canStart: true, canStop: false });\n  setStatus(\"Sharing stopped.\");\n}\n\nfunction cleanupPeers() {\n  peers.forEach(({ connection }) => connection.close());\n  peers.clear();\n}\n\nfunction createPeerConnection(viewerId: string): RTCPeerConnection {\n  if (!mediaStream) {\n    throw new Error(\"Media stream is not initialised\");\n  }\n\n  const connection = new RTCPeerConnection({\n    iceServers: [{ urls: \"stun:stun.l.google.com:19302\" }],\n  });\n\n  mediaStream.getTracks().forEach((track) => {\n    const sender = connection.addTrack(track, mediaStream!);\n\n    if (track.kind === \"video\") {\n      const parameters = sender.getParameters();\n      if (!parameters.encodings || parameters.encodings.length === 0) {\n        parameters.encodings = [{}];\n      }\n\n      parameters.encodings[0] = {\n        ...parameters.encodings[0],\n        maxBitrate: 18_000_000,\n        maxFramerate: 60,\n        scaleResolutionDownBy: 1,\n      };\n\n      void sender.setParameters(parameters);\n    } else if (track.kind === \"audio\") {\n      const parameters = sender.getParameters();\n      if (!parameters.encodings || parameters.encodings.length === 0) {\n        parameters.encodings = [{}];\n      }\n\n      parameters.encodings[0] = {\n        ...parameters.encodings[0],\n        maxBitrate: 192_000,\n      };\n\n      void sender.setParameters(parameters);\n    }\n  });\n\n  connection.onicecandidate = (event) => {\n    if (event.candidate && socket && socket.readyState === WebSocket.OPEN) {\n      socket.send(\n        JSON.stringify({\n          type: \"candidate\",\n          viewerId,\n          candidate: event.candidate,\n          origin: \"broadcaster\",\n        }),\n      );\n    }\n  };\n\n  connection.onconnectionstatechange = () => {\n    if (\n      connection.connectionState === \"disconnected\" ||\n      connection.connectionState === \"failed\" ||\n      connection.connectionState === \"closed\"\n    ) {\n      peers.delete(viewerId);\n    }\n  };\n\n  peers.set(viewerId, { connection });\n  return connection;\n}\n\nasync function handleViewerRequest(viewerId: string) {\n  if (!mediaStream) {\n    setStatus(\"Viewer connected but sharing not started yet.\");\n    pendingViewers.add(viewerId);\n    return;\n  }\n\n  pendingViewers.delete(viewerId);\n  const peer = createPeerConnection(viewerId);\n\n  const offer = await peer.createOffer({ offerToReceiveAudio: true, offerToReceiveVideo: true });\n  await peer.setLocalDescription(offer);\n\n  socket?.send(\n    JSON.stringify({\n      type: \"offer\",\n      viewerId,\n      sdp: offer,\n    }),\n  );\n\n  setStatus(`Sharing to ${peers.size} viewer(s).`);\n}\n\nasync function handleServerMessage(message: ServerMessage) {\n  switch (message.type) {\n    case \"registered\":\n      enableButtons({ canStart: true, canStop: false });\n      break;\n    case \"viewer-joined\":\n      await handleViewerRequest(message.viewerId);\n      break;\n    case \"viewer-left\":\n      peers.get(message.viewerId)?.connection.close();\n      peers.delete(message.viewerId);\n      pendingViewers.delete(message.viewerId);\n      setStatus(`Viewer left. ${peers.size} remaining.`);\n      break;\n    case \"viewer-missing\":\n      peers.get(message.viewerId)?.connection.close();\n      peers.delete(message.viewerId);\n      pendingViewers.delete(message.viewerId);\n      setStatus(\"Viewer disconnected before the offer completed.\");\n      break;\n    case \"answer\": {\n      const peer = peers.get(message.viewerId)?.connection;\n      if (peer) {\n        await peer.setRemoteDescription(message.sdp);\n      }\n      break;\n    }\n    case \"candidate\": {\n      const peer = peers.get(message.viewerId)?.connection;\n      if (peer && message.candidate) {\n        await peer.addIceCandidate(message.candidate);\n      }\n      break;\n    }\n    case \"viewer-count\": {\n      if (mediaStream) {\n        const viewerText = message.count === 1 ? \"1 viewer\" : `${message.count} viewers`;\n        setStatus(`Sharing to ${viewerText}.`);\n      }\n      break;\n    }\n    case \"stopped\":\n      stopBroadcast({ notifyServer: false });\n      break;\n    case \"error\":\n      setStatus(`Error: ${message.message}`);\n      break;\n    case \"broadcaster-ended\":\n      setStatus(\"Broadcast ended.\");\n      break;\n  }\n}\n\nstartButton.addEventListener(\"click\", () => {\n  void startBroadcast();\n});\n\nstopButton.addEventListener(\"click\", () => {\n  stopBroadcast({ notifyServer: true });\n});\n\nwindow.addEventListener(\"beforeunload\", () => {\n  stopBroadcast({ notifyServer: true });\n  socket?.close();\n});\n\nconnectSocket();\n\n"
  ],
  "mappings": "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",
  "debugId": "A0A8BC3A4D219CC864756E2164756E21",
  "names": []
}